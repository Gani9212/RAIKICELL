<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Raikicell - Pembukuan</title>
  <style>
    /* CSS sederhana untuk sidebar dan layout */
    body {
      margin: 0; font-family: Arial, sans-serif;
    }
    #app {
      display: flex; height: 100vh;
    }
    #sidebar {
      width: 200px; background: #333; color: white;
      display: flex; flex-direction: column;
    }
    #sidebar button {
      background: none; border: none; color: white;
      padding: 15px; cursor: pointer; text-align: left;
      border-bottom: 1px solid #444;
      font-size: 1rem;
    }
    #sidebar button:hover, #sidebar button.active {
      background: #555;
    }
    #content {
      flex: 1; padding: 20px; overflow-y: auto;
    }
    .hidden {
      display: none;
    }
    input, select, button {
      padding: 8px; margin: 5px 0; width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
    }
    form {
      max-width: 400px;
    }
    table {
      width: 100%; border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px; text-align: left;
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<div id="loginScreen" style="padding:20px; max-width:400px; margin:auto; margin-top:10vh; border:1px solid #ccc; border-radius:8px;">
  <h2>Login Raikicell</h2>
  <form id="loginForm">
    <input type="text" id="username" placeholder="Username" required autocomplete="off" />
    <input type="password" id="password" placeholder="Password" required autocomplete="off" />
    <button type="submit">Login</button>
  </form>
  <div id="loginError" style="color:red; margin-top:10px;"></div>
</div>

<div id="app" style="display:none;">
  <div id="sidebar">
    <button data-tab="konter" class="active">Transaksi Konter</button>
    <button data-tab="warung">Transaksi Warung</button>
    <button data-tab="tarikTunai">Tarik Tunai</button>
    <button data-tab="pengeluaran">Pengeluaran</button>
    <button data-tab="adminBarang">Admin Barang</button>
    <button data-tab="laporan">Laporan</button>
    <button id="logoutBtn" style="margin-top:auto; background:#a33;">Logout</button>
  </div>
  <div id="content">
    <!-- Konten tab akan muncul di sini -->
  </div>
</div>

<script>
  // Firebase config dan init
  const firebaseConfig = {
    apiKey: "AIzaSyDJ-3F7C9OdYFTM5MaUMdWn8qTnvQIDpRo",
    authDomain: "raikicell.firebaseapp.com",
    databaseURL: "https://raikicell-default-rtdb.firebaseio.com",
    projectId: "raikicell",
    storageBucket: "raikicell.appspot.com",
    messagingSenderId: "648628376778",
    appId: "1:648628376778:web:961ca9084abeeb206bd033"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Valid user
  const validUsername = "AE366813";
  const validPassword = "Raikicell1909";

  const loginScreen = document.getElementById('loginScreen');
  const app = document.getElementById('app');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const content = document.getElementById('content');
  const sidebarButtons = document.querySelectorAll('#sidebar button[data-tab]');
  const logoutBtn = document.getElementById('logoutBtn');

  // Global data arrays
  let transaksiKonter = [];
  let transaksiWarung = [];
  let tarikTunai = [];
  let pengeluaran = [];
  let daftarBarangAdmin = [];

  // Utility format rupiah
  function formatRupiah(num) {
    return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // --- LOGIN ---
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    loginError.textContent = '';

    if (username === validUsername && password === validPassword) {
      sessionStorage.setItem('loggedIn', 'true');
      loginScreen.style.display = 'none';
      app.style.display = 'flex';
      loadAllData();
      showTab('konter');
    } else {
      loginError.textContent = 'Username atau password salah!';
    }
  });

  // Jika sudah login simpan sesi
  if (sessionStorage.getItem('loggedIn') === 'true') {
    loginScreen.style.display = 'none';
    app.style.display = 'flex';
    loadAllData();
    showTab('konter');
  }

  logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem('loggedIn');
    location.reload();
  });

  // --- NAVIGATION ---
  sidebarButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      sidebarButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      showTab(btn.dataset.tab);
    });
  });

  // --- LOAD DATA from Firebase ---
  function loadAllData() {
    db.ref('transaksiKonter').on('value', snapshot => {
      transaksiKonter = snapshot.val() || [];
      if (currentTab === 'konter') renderTransaksiKonter();
    });
    db.ref('transaksiWarung').on('value', snapshot => {
      transaksiWarung = snapshot.val() || [];
      if (currentTab === 'warung') renderTransaksiWarung();
    });
    db.ref('tarikTunai').on('value', snapshot => {
      tarikTunai = snapshot.val() || [];
      if (currentTab === 'tarikTunai') renderTarikTunai();
    });
    db.ref('pengeluaran').on('value', snapshot => {
      pengeluaran = snapshot.val() || [];
      if (currentTab === 'pengeluaran') renderPengeluaran();
    });
    db.ref('daftarBarangAdmin').on('value', snapshot => {
      daftarBarangAdmin = snapshot.val() || [];
      if (currentTab === 'adminBarang') renderAdminBarang();
    });
  }

  // --- SAVE DATA to Firebase ---
  function saveData(path, data) {
    db.ref(path).set(data);
  }

  // --- RENDER TAB ---
  let currentTab = 'konter';
  function showTab(tab) {
    currentTab = tab;
    if(tab === 'konter') renderTransaksiKonter();
    else if(tab === 'warung') renderTransaksiWarung();
    else if(tab === 'tarikTunai') renderTarikTunai();
    else if(tab === 'pengeluaran') renderPengeluaran();
    else if(tab === 'adminBarang') renderAdminBarang();
    else if(tab === 'laporan') renderLaporan();
  }

  // --- RENDER TRANSAKSI KONTER ---
  function renderTransaksiKonter() {
    content.innerHTML = `
      <h2>Transaksi Konter</h2>
      <form id="formKonter">
        <label>Barang</label>
        <select id="barangKonter" required></select>
        <label>Jumlah</label>
        <input type="number" id="jumlahKonter" min="1" value="1" required />
        <button type="submit">Tambah Transaksi</button>
      </form>
      <table>
        <thead><tr><th>Tanggal</th><th>Barang</th><th>Jumlah</th><th>Harga</th><th>Fee</th><th>Aksi</th></tr></thead>
        <tbody id="tbodyKonter"></tbody>
      </table>
    `;
    // isi select barang dari daftarBarangAdmin
    const select = document.getElementById('barangKonter');
    select.innerHTML = daftarBarangAdmin.map((b,i) => `<option value="${i}">${b.nama}</option>`).join('');
    document.getElementById('formKonter').addEventListener('submit', e => {
      e.preventDefault();
      const barangIdx = parseInt(select.value);
      const jumlah = parseInt(document.getElementById('jumlahKonter').value);
      if (isNaN(jumlah) || jumlah < 1) return alert('Jumlah tidak valid!');
      const barang = daftarBarangAdmin[barangIdx];
      if (!barang) return alert('Barang tidak ditemukan!');
      transaksiKonter.push({
        tanggal: new Date().toISOString().slice(0,10),
        nama: barang.nama,
        jumlah,
        harga: barang.harga * jumlah,
        fee: barang.fee * jumlah
      });
      saveData('transaksiKonter', transaksiKonter);
    });
    renderTableKonter();
  }

  function renderTableKonter() {
    const tbody = document.getElementById('tbodyKonter');
    if (!tbody) return;
    tbody.innerHTML = transaksiKonter.map((t,i) => `
      <tr>
        <td>${t.tanggal}</td>
        <td>${t.nama}</td>
        <td>${t.jumlah}</td>
        <td>${formatRupiah(t.harga)}</td>
        <td>${formatRupiah(t.fee)}</td>
        <td><button onclick="deleteItem('transaksiKonter',${i})">Hapus</button></td>
      </tr>
    `).join('');
  }

  // --- RENDER TRANSAKSI WARUNG ---
  function renderTransaksiWarung() {
    content.innerHTML = `
      <h2>Transaksi Warung</h2>
      <form id="formWarung">
        <label>Barang</label>
        <select id="barangWarung" required></select>
        <label>Jumlah</label>
        <input type="number" id="jumlahWarung" min="1" value="1" required />
        <button type="submit">Tambah Transaksi</button>
      </form>
      <table>
        <thead><tr><th>Tanggal</th><th>Barang</th><th>Jumlah</th><th>Harga</th><th>Fee</th><th>Aksi</th></tr></thead>
        <tbody id="tbodyWarung"></tbody>
      </table>
    `;
    const select = document.getElementById('barangWarung');
    select.innerHTML = daftarBarangAdmin.map((b,i) => `<option value="${i}">${b.nama}</option>`).join('');
    document.getElementById('formWarung').addEventListener('submit', e => {
      e.preventDefault();
      const barangIdx = parseInt(select.value);
      const jumlah = parseInt(document.getElementById('jumlahWarung').value);
      if (isNaN(jumlah) || jumlah < 1) return alert('Jumlah tidak valid!');
      const barang = daftarBarangAdmin[barangIdx];
      if (!barang) return alert('Barang tidak ditemukan!');
      transaksiWarung.push({
        tanggal: new Date().toISOString().slice(0,10),
        nama: barang.nama,
        jumlah,
        harga: barang.harga * jumlah,
        fee: barang.fee * jumlah
      });
      saveData('transaksiWarung', transaksiWarung);
    });
    renderTableWarung();
  }

  function renderTableWarung() {
    const tbody = document.getElementById('tbodyWarung');
    if (!tbody) return;
    tbody.innerHTML = transaksiWarung.map((t,i) => `
      <tr>
        <td>${t.tanggal}</td>
        <td>${t.nama}</td>
        <td>${t.jumlah}</td>
        <td>${formatRupiah(t.harga)}</td>
        <td>${formatRupiah(t.fee)}</td>
        <td><button onclick="deleteItem('transaksiWarung',${i})">Hapus</button></td>
      </tr>
    `).join('');
  }

  // --- RENDER TARIK TUNAI ---
  function renderTarikTunai() {
    content.innerHTML = `
      <h2>Tarik Tunai</h2>
      <form id="formTarikTunai">
        <label>Jumlah</label>
        <input type="number" id="jumlahTarikTunai" min="0" required />
        <label>Fee</label>
        <input type="number" id="feeTarikTunai" min="0" required />
        <button type="submit">Tambah Tarik Tunai</button>
      </form>
      <table>
        <thead><tr><th>Tanggal</th><th>Jumlah</th><th>Fee</th><th>Aksi</th></tr></thead>
        <tbody id="tbodyTarikTunai"></tbody>
      </table>
    `;
    document.getElementById('formTarikTunai').addEventListener('submit', e => {
      e.preventDefault();
      const jumlah = parseInt(document.getElementById('jumlahTarikTunai').value);
      const fee = parseInt(document.getElementById('feeTarikTunai').value);
      if (isNaN(jumlah) || isNaN(fee) || jumlah < 0 || fee < 0) return alert('Input tidak valid!');
      tarikTunai.push({
        tanggal: new Date().toISOString().slice(0,10),
        jumlah,
        fee
      });
      saveData('tarikTunai', tarikTunai);
    });
    renderTableTarikTunai();
  }

  function renderTableTarikTunai() {
    const tbody = document.getElementById('tbodyTarikTunai');
    if (!tbody) return;
    tbody.innerHTML = tarikTunai.map((t,i) => `
      <tr>
        <td>${t.tanggal}</td>
        <td>${formatRupiah(t.jumlah)}</td>
        <td>${formatRupiah(t.fee)}</td>
        <td><button onclick="deleteItem('tarikTunai',${i})">Hapus</button></td>
      </tr>
    `).join('');
  }

  // --- RENDER PENGELUARAN ---
  function renderPengeluaran() {
    content.innerHTML = `
      <h2>Pengeluaran</h2>
      <form id="formPengeluaran">
        <label>Nama Pengeluaran</label>
        <input type="text" id="namaPengeluaran" required />
        <label>Jumlah</label>
        <input type="number" id="jumlahPengeluaran" min="0" required />
        <button type="submit">Tambah Pengeluaran</button>
      </form>
      <table>
        <thead><tr><th>Tanggal</th><th>Nama</th><th>Jumlah</th><th>Aksi</th></tr></thead>
        <tbody id="tbodyPengeluaran"></tbody>
      </table>
    `;
    document.getElementById('formPengeluaran').addEventListener('submit', e => {
      e.preventDefault();
      const nama = document.getElementById('namaPengeluaran').value.trim();
      const jumlah = parseInt(document.getElementById('jumlahPengeluaran').value);
      if (!nama || isNaN(jumlah) || jumlah < 0) return alert('Input tidak valid!');
      pengeluaran.push({
        tanggal: new Date().toISOString().slice(0,10),
        nama,
        jumlah
      });
      saveData('pengeluaran', pengeluaran);
    });
    renderTablePengeluaran();
  }

  function renderTablePengeluaran() {
    const tbody = document.getElementById('tbodyPengeluaran');
    if (!tbody) return;
    tbody.innerHTML = pengeluaran.map((t,i) => `
      <tr>
        <td>${t.tanggal}</td>
        <td>${t.nama}</td>
        <td>${formatRupiah(t.jumlah)}</td>
        <td><button onclick="deleteItem('pengeluaran',${i})">Hapus</button></td>
      </tr>
    `).join('');
  }

  // --- RENDER ADMIN BARANG ---
  function renderAdminBarang() {
    content.innerHTML = `
      <h2>Admin Barang</h2>
      <form id="formAdminBarang">
        <label>Nama Barang</label>
        <input type="text" id="namaBarangAdmin" required />
        <label>Harga</label>
        <input type="number" id="hargaAdmin" min="0" required />
        <label>Fee</label>
        <input type="number" id="feeAdmin" min="0" required />
        <button type="submit">Tambah Barang</button>
      </form>
      <input type="text" id="searchBarang" placeholder="Cari barang..." style="margin-top:10px; width: 100%;"/>
      <table>
        <thead><tr><th>Nama</th><th>Harga</th><th>Fee</th><th>Aksi</th></tr></thead>
        <tbody id="tbodyAdminBarang"></tbody>
      </table>
    `;
    document.getElementById('formAdminBarang').addEventListener('submit', e => {
      e.preventDefault();
      const nama = document.getElementById('namaBarangAdmin').value.trim();
      const harga = parseInt(document.getElementById('hargaAdmin').value);
      const fee = parseInt(document.getElementById('feeAdmin').value);
      if (!nama || isNaN(harga) || isNaN(fee) || harga < 0 || fee < 0) return alert('Input tidak valid!');
      daftarBarangAdmin.push({ nama, harga, fee });
      saveData('daftarBarangAdmin', daftarBarangAdmin);
      document.getElementById('formAdminBarang').reset();
    });
    document.getElementById('searchBarang').addEventListener('input', e => {
      const keyword = e.target.value.toLowerCase();
      renderTableAdminBarang(keyword);
    });
    renderTableAdminBarang('');
  }

  function renderTableAdminBarang(filter='') {
    const tbody = document.getElementById('tbodyAdminBarang');
    if (!tbody) return;
    tbody.innerHTML = daftarBarangAdmin
      .map((b,i) => ({...b, i}))
      .filter(b => b.nama.toLowerCase().includes(filter))
      .map(b => `
        <tr>
          <td>${b.nama}</td>
          <td>${formatRupiah(b.harga)}</td>
          <td>${formatRupiah(b.fee)}</td>
          <td><button onclick="deleteItem('daftarBarangAdmin',${b.i})">Hapus</button></td>
        </tr>
      `).join('');
  }

  // --- RENDER LAPORAN ---
  function renderLaporan() {
    // total keuntungan = total harga - total fee - pengeluaran - tarik tunai
    let totalHargaKonter = transaksiKonter.reduce((a,b) => a + b.harga, 0);
    let totalFeeKonter = transaksiKonter.reduce((a,b) => a + b.fee, 0);
    let totalHargaWarung = transaksiWarung.reduce((a,b) => a + b.harga, 0);
    let totalFeeWarung = transaksiWarung.reduce((a,b) => a + b.fee, 0);
    let totalTarikTunai = tarikTunai.reduce((a,b) => a + b.jumlah + b.fee, 0);
    let totalPengeluaran = pengeluaran.reduce((a,b) => a + b.jumlah, 0);
    let pendapatan = totalHargaKonter + totalHargaWarung;
    let totalFee = totalFeeKonter + totalFeeWarung;
    let keuntungan = pendapatan - totalFee - totalTarikTunai - totalPengeluaran;

    content.innerHTML = `
      <h2>Laporan Keuangan</h2>
      <table>
        <tr><th>Total Pendapatan</th><td>${formatRupiah(pendapatan)}</td></tr>
        <tr><th>Total Fee</th><td>${formatRupiah(totalFee)}</td></tr>
        <tr><th>Total Tarik Tunai + Fee</th><td>${formatRupiah(totalTarikTunai)}</td></tr>
        <tr><th>Total Pengeluaran</th><td>${formatRupiah(totalPengeluaran)}</td></tr>
        <tr><th>Keuntungan Bersih</th><td>${formatRupiah(keuntungan)}</td></tr>
      </table>
    `;
  }

  // --- HAPUS ITEM ---
  function deleteItem(path, index) {
    if (!confirm('Yakin ingin menghapus data ini?')) return;
    if (path === 'transaksiKonter') {
      transaksiKonter.splice(index,1);
      saveData(path, transaksiKonter);
      renderTransaksiKonter();
    } else if (path === 'transaksiWarung') {
      transaksiWarung.splice(index,1);
      saveData(path, transaksiWarung);
      renderTransaksiWarung();
    } else if (path === 'tarikTunai') {
      tarikTunai.splice(index,1);
      saveData(path, tarikTunai);
      renderTarikTunai();
    } else if (path === 'pengeluaran') {
      pengeluaran.splice(index,1);
      saveData(path, pengeluaran);
      renderPengeluaran();
    } else if (path === 'daftarBarangAdmin') {
      daftarBarangAdmin.splice(index,1);
      saveData(path, daftarBarangAdmin);
      renderAdminBarang();
    }
  }

  // Biar bisa dipanggil dari button di tabel
  window.deleteItem = deleteItem;

</script>
</body>
</html>
