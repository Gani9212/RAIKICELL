<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Pembukuan Raikicell</title>
  <style>
    /* Reset */
    * { box-sizing: border-box; }
    body, html { margin:0; padding:0; font-family: Arial, sans-serif; height: 100vh; display: flex; }
    /* Sidebar */
    #sidebar {
      width: 200px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
    }
    #sidebar button {
      background: none;
      border: none;
      color: white;
      padding: 15px 20px;
      text-align: left;
      width: 100%;
      cursor: pointer;
      font-size: 16px;
      border-left: 4px solid transparent;
      transition: background 0.3s, border-left 0.3s;
    }
    #sidebar button.active, #sidebar button:hover {
      background: #34495e;
      border-left: 4px solid #1abc9c;
    }
    /* Content area */
    #content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      background: #ecf0f1;
    }
    /* Hidden sections */
    section { display: none; }
    section.active { display: block; }

    /* Form styling */
    form {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      max-width: 400px;
    }
    form input, form select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
    }
    form button {
      background: #1abc9c;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      cursor: pointer;
      font-size: 16px;
      border-radius: 4px;
    }
    form button:hover {
      background: #16a085;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 10px;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    table th, table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    table th {
      background: #1abc9c;
      color: white;
    }
    .delete-button {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .delete-button:hover {
      background: #c0392b;
    }

    /* Login overlay */
    #loginOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
    }
    #loginBox {
      background: white; padding: 20px; border-radius: 8px; width: 320px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #loginBox input {
      width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box;
    }
    #loginBox button {
      width: 100%; padding: 10px; background: #4CAF50; color: white;
      border: none; cursor: pointer;
    }
    #loginBox button:hover {
      background: #45a049;
    }
    #errorMsg {
      color: red; font-size: 0.9em; height: 1.2em;
    }
    body.not-logged-in > *:not(#loginOverlay) {
      display: none !important;
    }
  </style>
</head>
<body class="not-logged-in">

  <div id="loginOverlay">
    <div id="loginBox">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Username" autocomplete="off" />
      <input type="password" id="password" placeholder="Password" autocomplete="off" />
      <button id="loginBtn">Login</button>
      <div id="errorMsg"></div>
    </div>
  </div>

  <div id="sidebar">
    <button data-tab="konter" class="active">Transaksi Konter</button>
    <button data-tab="warung">Transaksi Warung</button>
    <button data-tab="tarikTunai">Tarik Tunai</button>
    <button data-tab="pengeluaran">Pengeluaran</button>
    <button data-tab="adminBarang">Admin Barang</button>
    <button data-tab="laporan">Laporan</button>
  </div>

  <div id="content">
    <!-- Transaksi Konter -->
    <section id="konter" class="active">
      <h2>Transaksi Konter</h2>
      <form id="formKonter">
        <input type="text" id="namaBarangKonter" placeholder="Nama Barang" required />
        <input type="number" id="hargaKonter" placeholder="Harga" min="0" required />
        <input type="number" id="feeKonter" placeholder="Fee" min="0" required />
        <button type="submit">Tambah Transaksi</button>
      </form>
      <table id="tableKonter">
        <thead>
          <tr>
            <th>Nama Barang</th>
            <th>Harga</th>
            <th>Fee</th>
            <th>Tanggal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Transaksi Warung -->
    <section id="warung">
      <h2>Transaksi Warung</h2>
      <form id="formWarung">
        <input type="text" id="namaBarangWarung" placeholder="Nama Barang" required />
        <input type="number" id="hargaWarung" placeholder="Harga" min="0" required />
        <input type="number" id="feeWarung" placeholder="Fee" min="0" required />
        <button type="submit">Tambah Transaksi</button>
      </form>
      <table id="tableWarung">
        <thead>
          <tr>
            <th>Nama Barang</th>
            <th>Harga</th>
            <th>Fee</th>
            <th>Tanggal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Tarik Tunai -->
    <section id="tarikTunai">
      <h2>Tarik Tunai</h2>
      <form id="formTarikTunai">
        <input type="number" id="jumlahTarikTunai" placeholder="Jumlah" min="0" required />
        <input type="number" id="feeTarikTunai" placeholder="Fee" min="0" required />
        <button type="submit">Tambah Tarik Tunai</button>
      </form>
      <table id="tableTarikTunai">
        <thead>
          <tr>
            <th>Jumlah</th>
            <th>Fee</th>
            <th>Tanggal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Pengeluaran -->
    <section id="pengeluaran">
      <h2>Pengeluaran</h2>
      <form id="formPengeluaran">
        <input type="text" id="namaPengeluaran" placeholder="Nama Pengeluaran" required />
        <input type="number" id="jumlahPengeluaran" placeholder="Jumlah" min="0" required />
        <button type="submit">Tambah Pengeluaran</button>
      </form>
      <table id="tablePengeluaran">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Jumlah</th>
            <th>Tanggal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Admin Barang -->
    <section id="adminBarang">
      <h2>Admin Barang</h2>
      <form id="formAdmin">
        <input type="text" id="namaBarangAdmin" placeholder="Nama Barang" required />
        <input type="number" id="hargaAdmin" placeholder="Harga" min="0" required />
        <input type="number" id="feeAdmin" placeholder="Fee" min="0" required />
        <button type="submit">Tambah Barang</button>
      </form>
      <input type="text" id="searchBarang" placeholder="Cari Barang..." />
      <table id="tableAdminBarang">
        <thead>
          <tr>
            <th>Nama Barang</th>
            <th>Harga</th>
            <th>Fee</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Laporan -->
    <section id="laporan">
      <h2>Laporan</h2>
      <div>
        <h3>Laporan Harian</h3>
        <input type="date" id="tanggalLaporanHarian" />
        <button id="btnGenerateLaporanHarian">Generate Laporan Harian</button>
        <p id="laporanHarianResult"></p>
      </div>
      <div>
        <h3>Laporan Bulanan</h3>
        <input type="month" id="bulanLaporanBulanan" />
        <button id="btnGenerateLaporanBulanan">Generate Laporan Bulanan</button>
        <p id="laporanBulananResult"></p>
      </div>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCxqXqls0Wmoqz8yO65Jmo92Mzx4ZdMoE0",
      authDomain: "raikicell.firebaseapp.com",
      databaseURL: "https://raikicell-default-rtdb.firebaseio.com",
      projectId: "raikicell",
      storageBucket: "raikicell.appspot.com",
      messagingSenderId: "648628376778",
      appId: "1:648628376778:web:961ca9084abeeb206bd033"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ======== AUTH =========
    const validUsername = "AE366813";
    const validPassword = "Raikicell1909";
    const loginOverlay = document.getElementById('loginOverlay');
    const errorMsg = document.getElementById('errorMsg');
    const loginBtn = document.getElementById('loginBtn');

    document.body.classList.add('not-logged-in');

    loginBtn.addEventListener('click', () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      if (username === validUsername && password === validPassword) {
        document.body.classList.remove('not-logged-in');
        loginOverlay.style.display = 'none';
        sessionStorage.setItem('loggedIn', 'true');
        loadAllData();
      } else {
        errorMsg.textContent = 'Username atau password salah!';
      }
    });

    if (sessionStorage.getItem('loggedIn') === 'true') {
      document.body.classList.remove('not-logged-in');
      loginOverlay.style.display = 'none';
      loadAllData();
    }

    // ======== NAVIGATION =========
    const buttons = document.querySelectorAll('#sidebar button');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        // remove active class all
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // show tab section
        const tab = btn.dataset.tab;
        document.querySelectorAll('section').forEach(sec => {
          sec.classList.toggle('active', sec.id === tab);
        });
      });
    });

    // ======== HELPER =========
    function formatRupiah(num) {
      return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // ======== DATA HANDLERS =========
    // Each data type will have functions to load, render, add, and delete

    // --- TRANSAKSI KONTER ---
    const formKonter = document.getElementById('formKonter');
    const tableKonterBody = document.querySelector('#tableKonter tbody');

    formKonter.addEventListener('submit', e => {
      e.preventDefault();
      const nama = document.getElementById('namaBarangKonter').value.trim();
      const harga = parseInt(document.getElementById('hargaKonter').value);
      const fee = parseInt(document.getElementById('feeKonter').value);

      if (!nama || isNaN(harga) || isNaN(fee) || harga < 0 || fee < 0) {
        return alert('Input tidak valid!');
      }

      const newData = {
        nama, harga, fee,
        tanggal: new Date().toISOString().slice(0,10)
      };

      db.ref('transaksiKonter').push(newData)
        .then(() => {
          formKonter.reset();
        })
        .catch(err => alert('Gagal menyimpan data: ' + err));
    });

    function renderTableKonter(data) {
      tableKonterBody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.val.nama}</td>
          <td>${formatRupiah(item.val.harga)}</td>
          <td>${formatRupiah(item.val.fee)}</td>
          <td>${item.val.tanggal}</td>
          <td><button class="delete-button" data-type="transaksiKonter" data-key="${item.key}">Hapus</button></td>
        `;
        tableKonterBody.appendChild(tr);
      });
    }

    // --- TRANSAKSI WARUNG ---
    const formWarung = document.getElementById('formWarung');
    const tableWarungBody = document.querySelector('#tableWarung tbody');

    formWarung.addEventListener('submit', e => {
      e.preventDefault();
      const nama = document.getElementById('namaBarangWarung').value.trim();
      const harga = parseInt(document.getElementById('hargaWarung').value);
      const fee = parseInt(document.getElementById('feeWarung').value);

      if (!nama || isNaN(harga) || isNaN(fee) || harga < 0 || fee < 0) {
        return alert('Input tidak valid!');
      }

      const newData = {
        nama, harga, fee,
        tanggal: new Date().toISOString().slice(0,10)
      };

      db.ref('transaksiWarung').push(newData)
        .then(() => formWarung.reset())
        .catch(err => alert('Gagal menyimpan data: ' + err));
    });

    function renderTableWarung(data) {
      tableWarungBody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.val.nama}</td>
          <td>${formatRupiah(item.val.harga)}</td>
          <td>${formatRupiah(item.val.fee)}</td>
          <td>${item.val.tanggal}</td>
          <td><button class="delete-button" data-type="transaksiWarung" data-key="${item.key}">Hapus</button></td>
        `;
        tableWarungBody.appendChild(tr);
      });
    }

    // --- TARIK TUNAI ---
    const formTarikTunai = document.getElementById('formTarikTunai');
    const tableTarikTunaiBody = document.querySelector('#tableTarikTunai tbody');

    formTarikTunai.addEventListener('submit', e => {
      e.preventDefault();
      const jumlah = parseInt(document.getElementById('jumlahTarikTunai').value);
      const fee = parseInt(document.getElementById('feeTarikTunai').value);
      if (isNaN(jumlah) || isNaN(fee) || jumlah < 0 || fee < 0) return alert('Input tidak valid!');

      const newData = {
        jumlah, fee,
        tanggal: new Date().toISOString().slice(0,10)
      };

      db.ref('tarikTunai').push(newData)
        .then(() => formTarikTunai.reset())
        .catch(err => alert('Gagal menyimpan data: ' + err));
    });

    function renderTableTarikTunai(data) {
      tableTarikTunaiBody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatRupiah(item.val.jumlah)}</td>
          <td>${formatRupiah(item.val.fee)}</td>
          <td>${item.val.tanggal}</td>
          <td><button class="delete-button" data-type="tarikTunai" data-key="${item.key}">Hapus</button></td>
        `;
        tableTarikTunaiBody.appendChild(tr);
      });
    }

    // --- PENGELUARAN ---
    const formPengeluaran = document.getElementById('formPengeluaran');
    const tablePengeluaranBody = document.querySelector('#tablePengeluaran tbody');

    formPengeluaran.addEventListener('submit', e => {
      e.preventDefault();
      const nama = document.getElementById('namaPengeluaran').value.trim();
      const jumlah = parseInt(document.getElementById('jumlahPengeluaran').value);
      if (!nama || isNaN(jumlah) || jumlah < 0) return alert('Input tidak valid!');

      const newData = { nama, jumlah, tanggal: new Date().toISOString().slice(0,10) };

      db.ref('pengeluaran').push(newData)
        .then(() => formPengeluaran.reset())
        .catch(err => alert('Gagal menyimpan data: ' + err));
    });

    function renderTablePengeluaran(data) {
      tablePengeluaranBody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.val.nama}</td>
          <td>${formatRupiah(item.val.jumlah)}</td>
          <td>${item.val.tanggal}</td>
          <td><button class="delete-button" data-type="pengeluaran" data-key="${item.key}">Hapus</button></td>
        `;
        tablePengeluaranBody.appendChild(tr);
      });
    }

    // --- ADMIN BARANG ---
    const formAdmin = document.getElementById('formAdmin');
    const tableAdminBody = document.querySelector('#tableAdminBarang tbody');
    const searchBarangInput = document.getElementById('searchBarang');

    formAdmin.addEventListener('submit', e => {
      e.preventDefault();
      const nama = document.getElementById('namaBarangAdmin').value.trim();
      const harga = parseInt(document.getElementById('hargaAdmin').value);
      const fee = parseInt(document.getElementById('feeAdmin').value);
      if (!nama || isNaN(harga) || isNaN(fee) || harga < 0 || fee < 0) return alert('Input tidak valid!');

      const newData = { nama, harga, fee };
      db.ref('adminBarang').push(newData)
        .then(() => formAdmin.reset())
        .catch(err => alert('Gagal menyimpan data: ' + err));
    });

    function renderTableAdminBarang(data, filter='') {
      tableAdminBody.innerHTML = '';
      data.forEach(item => {
        if (filter && !item.val.nama.toLowerCase().includes(filter.toLowerCase())) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.val.nama}</td>
          <td>${formatRupiah(item.val.harga)}</td>
          <td>${formatRupiah(item.val.fee)}</td>
          <td><button class="delete-button" data-type="adminBarang" data-key="${item.key}">Hapus</button></td>
        `;
        tableAdminBody.appendChild(tr);
      });
    }

    searchBarangInput.addEventListener('input', () => {
      loadAdminBarang(searchBarangInput.value.trim());
    });

    // ======== DELETE BUTTONS HANDLER =========
    document.body.addEventListener('click', e => {
      if (e.target.classList.contains('delete-button')) {
        const type = e.target.dataset.type;
        const key = e.target.dataset.key;
        if (confirm('Yakin ingin menghapus data ini?')) {
          db.ref(type + '/' + key).remove();
        }
      }
    });

    // ======== LOAD ALL DATA AND LISTENERS =========
    function loadAllData() {
      // Konter
      db.ref('transaksiKonter').on('value', snapshot => {
        const data = [];
        snapshot.forEach(child => data.push({ key: child.key, val: child.val() }));
        renderTableKonter(data);
      });

      // Warung
      db.ref('transaksiWarung').on('value', snapshot => {
        const data = [];
        snapshot.forEach(child => data.push({ key: child.key, val: child.val() }));
        renderTableWarung(data);
      });

      // Tarik Tunai
      db.ref('tarikTunai').on('value', snapshot => {
        const data = [];
        snapshot.forEach(child => data.push({ key: child.key, val: child.val() }));
        renderTableTarikTunai(data);
      });

      // Pengeluaran
      db.ref('pengeluaran').on('value', snapshot => {
        const data = [];
        snapshot.forEach(child => data.push({ key: child.key, val: child.val() }));
        renderTablePengeluaran(data);
      });

      // Admin Barang
      db.ref('adminBarang').on('value', snapshot => {
        const data = [];
        snapshot.forEach(child => data.push({ key: child.key, val: child.val() }));
        renderTableAdminBarang(data, searchBarangInput.value.trim());
      });
    }

    // ======== LAPORAN =========
    document.getElementById('btnGenerateLaporanHarian').addEventListener('click', () => {
      const tgl = document.getElementById('tanggalLaporanHarian').value;
      if (!tgl) return alert('Pilih tanggal dulu!');
      generateLaporan(tgl, 'harian');
    });

    document.getElementById('btnGenerateLaporanBulanan').addEventListener('click', () => {
      const bln = document.getElementById('bulanLaporanBulanan').value;
      if (!bln) return alert('Pilih bulan dulu!');
      generateLaporan(bln, 'bulanan');
    });

    async function generateLaporan(dateOrMonth, type) {
      // type: 'harian' or 'bulanan'
      // ambil semua data dan filter sesuai tanggal/bulan
      const snapshotKonter = await db.ref('transaksiKonter').once('value');
      const snapshotWarung = await db.ref('transaksiWarung').once('value');
      const snapshotTarikTunai = await db.ref('tarikTunai').once('value');
      const snapshotPengeluaran = await db.ref('pengeluaran').once('value');

      function filterByDate(itemDate) {
        if (type === 'harian') return itemDate === dateOrMonth;
        else if (type === 'bulanan') return itemDate.startsWith(dateOrMonth);
      }

      let totalPendapatan = 0;
      let totalFee = 0;
      let totalPengeluaran = 0;
      let totalTarikTunai = 0;

      // Konter
      snapshotKonter.forEach(child => {
        const d = child.val();
        if (filterByDate(d.tanggal)) {
          totalPendapatan += d.harga;
          totalFee += d.fee;
        }
      });
      // Warung
      snapshotWarung.forEach(child => {
        const d = child.val();
        if (filterByDate(d.tanggal)) {
          totalPendapatan += d.harga;
          totalFee += d.fee;
        }
      });
      // Tarik Tunai
      snapshotTarikTunai.forEach(child => {
        const d = child.val();
        if (filterByDate(d.tanggal)) {
          totalTarikTunai += d.jumlah;
          totalFee += d.fee;
        }
      });
      // Pengeluaran
      snapshotPengeluaran.forEach(child => {
        const d = child.val();
        if (filterByDate(d.tanggal)) {
          totalPengeluaran += d.jumlah;
        }
      });

      const keuntungan = totalPendapatan - totalFee - totalPengeluaran - totalTarikTunai;

      const resultText = `
        Total Pendapatan: ${formatRupiah(totalPendapatan)}<br>
        Total Fee: ${formatRupiah(totalFee)}<br>
        Total Pengeluaran: ${formatRupiah(totalPengeluaran)}<br>
        Total Tarik Tunai: ${formatRupiah(totalTarikTunai)}<br>
        <b>Keuntungan Bersih: ${formatRupiah(keuntungan)}</b>
      `;

      if (type === 'harian') {
        document.getElementById('laporanHarianResult').innerHTML = resultText;
      } else {
        document.getElementById('laporanBulananResult').innerHTML = resultText;
      }
    }
  </script>
</body>
</html>
