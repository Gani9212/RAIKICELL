<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pembukuan Usaha</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
  }
  nav {
    width: 220px;
    background: #2c3e50;
    color: #ecf0f1;
    display: flex;
    flex-direction: column;
  }
  nav button {
    background: none;
    border: none;
    color: inherit;
    padding: 15px 20px;
    cursor: pointer;
    text-align: left;
    font-size: 16px;
    border-left: 4px solid transparent;
  }
  nav button.active {
    background: #34495e;
    border-left-color: #1abc9c;
    font-weight: bold;
  }
  main {
    flex-grow: 1;
    padding: 1rem 2rem;
    overflow-y: auto;
    background: #ecf0f1;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  h2 {
    margin-top: 0;
  }
  form {
    margin-bottom: 2rem;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    margin-bottom: 12px;
    box-sizing: border-box;
  }
  button.submit-btn {
    background: #1abc9c;
    border: none;
    padding: 10px 15px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    border-radius: 3px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2rem;
  }
  table th, table td {
    border: 1px solid #bdc3c7;
    padding: 8px 12px;
    text-align: left;
  }
  table th {
    background: #34495e;
    color: white;
  }
  .number {
    text-align: right;
  }
  #laporan .laporan-item {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #bdc3c7;
  }
  #laporan .label {
    font-weight: 600;
  }
  #laporan .value {
    font-weight: 700;
    color: #2c3e50;
  }
</style>
</head>
<body>
<nav>
  <button id="tabKonter" class="active">Transaksi Konter</button>
  <button id="tabWarung">Transaksi Warung</button>
  <button id="tabTarikTunai">Tarik Tunai</button>
  <button id="tabPengeluaran">Pengeluaran</button>
  <button id="tabLaporan">Laporan</button>
</nav>
<main>
  <section id="konter" class="active">
    <h2>Transaksi Konter</h2>
    <form id="formKonter">
      <label for="namaKonter">Nama Barang</label>
      <input type="text" id="namaKonter" name="nama" required />
      <label for="hargaJualKonter">Harga Jual</label>
      <input type="number" id="hargaJualKonter" name="hargaJual" min="0" required />
      <label for="feeKonter">Fee</label>
      <input type="number" id="feeKonter" name="fee" min="0" required />
      <button type="submit" class="submit-btn">Tambah Transaksi</button>
    </form>
    <table id="tableKonter">
      <thead><tr><th>Nama</th><th>Harga Jual</th><th>Fee</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
  <section id="warung">
    <h2>Transaksi Warung</h2>
    <form id="formWarung">
      <label for="namaWarung">Nama Barang</label>
      <input type="text" id="namaWarung" name="nama" required />
      <label for="hargaJualWarung">Harga Jual</label>
      <input type="number" id="hargaJualWarung" name="hargaJual" min="0" required />
      <label for="feeWarung">Fee</label>
      <input type="number" id="feeWarung" name="fee" min="0" required />
      <button type="submit" class="submit-btn">Tambah Transaksi</button>
    </form>
    <table id="tableWarung">
      <thead><tr><th>Nama</th><th>Harga Jual</th><th>Fee</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
  <section id="tarikTunai">
    <h2>Tarik Tunai</h2>
    <form id="formTarikTunai">
      <label for="jumlahTarikTunai">Jumlah Tarik Tunai</label>
      <input type="number" id="jumlahTarikTunai" name="jumlah" min="0" required />
      <label for="feeTarikTunai">Fee Tarik Tunai</label>
      <input type="number" id="feeTarikTunai" name="fee" min="0" value="0" required />
      <button type="submit" class="submit-btn">Tambah Tarik Tunai</button>
    </form>
    <table id="tableTarikTunai">
      <thead><tr><th>Jumlah Tarik Tunai</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
  <section id="pengeluaran">
    <h2>Pengeluaran</h2>
    <form id="formPengeluaran">
      <label for="namaPengeluaran">Nama Pengeluaran</label>
      <input type="text" id="namaPengeluaran" name="nama" required />
      <label for="jumlahPengeluaran">Jumlah Pengeluaran</label>
      <input type="number" id="jumlahPengeluaran" name="jumlah" min="0" required />
      <button type="submit" class="submit-btn">Tambah Pengeluaran</button>
    </form>
    <table id="tablePengeluaran">
      <thead><tr><th>Nama</th><th>Jumlah</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
  <section id="laporan">
    <h2>Laporan</h2>
    <div id="laporan-total">
      <div class="laporan-item"><span class="label">Total Harga Jual:</span> <span class="value" id="totalHargaJual">0</span></div>
      <div class="laporan-item"><span class="label">Total Fee:</span> <span class="value" id="totalFee">0</span></div>
      <div class="laporan-item"><span class="label">Total Tarik Tunai:</span> <span class="value" id="totalTarikTunai">0</span></div>
      <div class="laporan-item"><span class="label">Total Pengeluaran:</span> <span class="value" id="totalPengeluaran">0</span></div>
      <div class="laporan-item"><span class="label">Keuntungan Kotor:</span> <span class="value" id="keuntunganKotor">0</span></div>
      <div class="laporan-item"><span class="label">Keuntungan Bersih:</span> <span class="value" id="keuntunganBersih">0</span></div>
    </div>
    <!-- Laporan harian & bulanan akan muncul di sini otomatis -->
  </section>
</main>

<script type="module">
// Firebase setup
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyCoI53ZeXyaOBCOaczkPbHJpWzi0DX4b8g",
  authDomain: "raikicell.firebaseapp.com",
  databaseURL: "https://raikicell-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "raikicell",
  storageBucket: "raikicell.firebasestorage.app",
  messagingSenderId: "648628376778",
  appId: "1:648628376778:web:70098faf30f123ed6bd033",
  measurementId: "G-WWT1K74HHR"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

// Tab nav
const tabs = ["konter","warung","tarikTunai","pengeluaran","laporan"];
tabs.forEach(id => {
  document.getElementById("tab"+capitalizeFirstLetter(id)).addEventListener("click", () => {
    tabs.forEach(t => {
      document.getElementById(t).classList.remove("active");
      document.getElementById("tab"+capitalizeFirstLetter(t)).classList.remove("active");
    });
    document.getElementById(id).classList.add("active");
    document.getElementById("tab"+capitalizeFirstLetter(id)).classList.add("active");
  });
});

function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

function formatRupiah(number) {
  return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
}

// Update laporan function with fee tarik tunai & laporan harian & bulanan
async function updateLaporan() {
  const konterRef = ref(db, 'transaksi/konter');
  const warungRef = ref(db, 'transaksi/warung');
  const tarikTunaiRef = ref(db, 'transaksi/tarikTunai');
  const pengeluaranRef = ref(db, 'transaksi/pengeluaran');

  function fetchData(dbRef) {
    return new Promise(resolve => {
      onValue(dbRef, snapshot => resolve(snapshot), { onlyOnce: true });
    });
  }

  let totalHargaJual = 0;
  let totalFee = 0;
  let totalTarikTunai = 0;
  let totalPengeluaran = 0;

  let harian = {
    hargaJual: 0,
    fee: 0,
    tarikTunai: 0,
    pengeluaran: 0,
  };
  let bulanan = {
    hargaJual: 0,
    fee: 0,
    tarikTunai: 0,
    pengeluaran: 0,
  };

  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);
  const thisMonthStr = today.toISOString().slice(0,7);

  // Helper to check if date starts with YYYY-MM
  function isSameMonth(dateStr) {
    return dateStr.startsWith(thisMonthStr);
  }
  function isSameDay(dateStr) {
    return dateStr === todayStr;
  }

  // KONTER
  const konterSnap = await fetchData(konterRef);
  konterSnap.forEach(child => {
    const data = child.val();
    totalHargaJual += data.hargaJual || 0;
    totalFee += data.fee || 0;

    if(data.tanggal) {
      if(isSameDay(data.tanggal)) {
        harian.hargaJual += data.hargaJual || 0;
        harian.fee += data.fee || 0;
      }
      if(isSameMonth(data.tanggal)) {
        bulanan.hargaJual += data.hargaJual || 0;
        bulanan.fee += data.fee || 0;
      }
    }
  });

  // WARUNG
  const warungSnap = await fetchData(warungRef);
  warungSnap.forEach(child => {
    const data = child.val();
    totalHargaJual += data.hargaJual || 0;
    totalFee += data.fee || 0;

    if(data.tanggal) {
      if(isSameDay(data.tanggal)) {
        harian.hargaJual += data.hargaJual || 0;
        harian.fee += data.fee || 0;
      }
      if(isSameMonth(data.tanggal)) {
        bulanan.hargaJual += data.hargaJual || 0;
        bulanan.fee += data.fee || 0;
      }
    }
  });

  // TARIK TUNAI
  const tarikTunaiSnap = await fetchData(tarikTunaiRef);
  tarikTunaiSnap.forEach(child => {
    const data = child.val();
    totalTarikTunai += data.jumlah || 0;
    totalFee += data.fee || 0; // Fee juga dihitung total fee

    if(data.tanggal) {
      if(isSameDay(data.tanggal)) {
        harian.tarikTunai += data.jumlah || 0;
        harian.fee += data.fee || 0;
      }
      if(isSameMonth(data.tanggal)) {
        bulanan.tarikTunai += data.jumlah || 0;
        bulanan.fee += data.fee || 0;
      }
    }
  });

  // PENGELUARAN
  const pengeluaranSnap = await fetchData(pengeluaranRef);
  pengeluaranSnap.forEach(child => {
    const data = child.val();
    totalPengeluaran += data.jumlah || 0;

    if(data.tanggal) {
      if(isSameDay(data.tanggal)) {
        harian.pengeluaran += data.jumlah || 0;
      }
      if(isSameMonth(data.tanggal)) {
        bulanan.pengeluaran += data.jumlah || 0;
      }
    }
  });

  // Hitung keuntungan
  // Keuntungan kotor = (Harga Jual + Fee) - (Tarik Tunai + Pengeluaran)
  const keuntunganKotor = (totalHargaJual + totalFee) - (totalTarikTunai + totalPengeluaran);
  const keuntunganBersih = keuntunganKotor;

  // Harian
  const keuntunganKotorHarian = (harian.hargaJual + harian.fee) - (harian.tarikTunai + harian.pengeluaran);
  const keuntunganBersihHarian = keuntunganKotorHarian;

  // Bulanan
  const keuntunganKotorBulanan = (bulanan.hargaJual + bulanan.fee) - (bulanan.tarikTunai + bulanan.pengeluaran);
  const keuntunganBersihBulanan = keuntunganKotorBulanan;

  // Update UI total
  document.getElementById("totalHargaJual").textContent = formatRupiah(totalHargaJual);
  document.getElementById("totalFee").textContent = formatRupiah(totalFee);
  document.getElementById("totalTarikTunai").textContent = formatRupiah(totalTarikTunai);
  document.getElementById("totalPengeluaran").textContent = formatRupiah(totalPengeluaran);
  document.getElementById("keuntunganKotor").textContent = formatRupiah(keuntunganKotor);
  document.getElementById("keuntunganBersih").textContent = formatRupiah(keuntunganBersih);

  // Update tabel data
  function updateTable(tableId, dataList, columns) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = "";
    dataList.forEach(data => {
      const tr = document.createElement("tr");
      columns.forEach(col => {
        const td = document.createElement("td");
        td.textContent = col in data ? (col === "hargaJual" || col === "fee" || col === "jumlah" ? formatRupiah(data[col]) : data[col]) : "";
        if (col === "hargaJual" || col === "fee" || col === "jumlah") td.classList.add("number");
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  // Ambil data semua transaksi untuk update tabel
  function snapshotToList(snap, keys) {
    const list = [];
    snap.forEach(child => {
      const val = child.val();
      const obj = {};
      keys.forEach(k => obj[k] = val[k]);
      list.push(obj);
    });
    return list;
  }

  updateTable("tableKonter", snapshotToList(konterSnap, ["nama", "hargaJual", "fee"]), ["nama","hargaJual","fee"]);
  updateTable("tableWarung", snapshotToList(warungSnap, ["nama", "hargaJual", "fee"]), ["nama","hargaJual","fee"]);
  updateTable("tableTarikTunai", snapshotToList(tarikTunaiSnap, ["jumlah"]), ["jumlah"]);
  updateTable("tablePengeluaran", snapshotToList(pengeluaranSnap, ["nama", "jumlah"]), ["nama","jumlah"]);

  // Tambah laporan harian & bulanan di bawah laporan total (kalau belum ada)
  if (!document.getElementById('laporan-extra')) {
    const laporanExtra = document.createElement('div');
    laporanExtra.id = 'laporan-extra';
    laporanExtra.style.marginTop = '2rem';
    laporanExtra.innerHTML = `
      <h3>Laporan Harian (${todayStr})</h3>
      <div class="laporan-item"><span class="label">Harga Jual:</span> <span class="value" id="harianHargaJual">0</span></div>
      <div class="laporan-item"><span class="label">Fee:</span> <span class="value" id="harianFee">0</span></div>
      <div class="laporan-item"><span class="label">Tarik Tunai:</span> <span class="value" id="harianTarikTunai">0</span></div>
      <div class="laporan-item"><span class="label">Pengeluaran:</span> <span class="value" id="harianPengeluaran">0</span></div>
      <div class="laporan-item"><span class="label">Keuntungan Kotor:</span> <span class="value" id="harianKeuntunganKotor">0</span></div>
      <div class="laporan-item"><span class="label">Keuntungan Bersih:</span> <span class="value" id="harianKeuntunganBersih">0</span></div>

      <h3 style="margin-top:2rem;">Laporan Bulanan (${thisMonthStr})</h3>
      <div class="laporan-item"><span class="label">Harga Jual:</span> <span class="value" id="bulananHargaJual">0</span></div>
      <div class="laporan-item"><span class="label">Fee:</span> <span class="value" id="bulananFee">0</span></div>
      <div class="laporan-item"><span class="label">Tarik Tunai:</span> <span class="value" id="bulananTarikTunai">0</span></div>
      <div class="laporan-item"><span class="label">Pengeluaran:</span> <span class="value" id="bulananPengeluaran">0</span></div>
      <div class="laporan-item"><span class="label">Keuntungan Kotor:</span> <span class="value" id="bulananKeuntunganKotor">0</span></div>
      <div class="laporan-item"><span class="label">Keuntungan Bersih:</span> <span class="value" id="bulananKeuntunganBersih">0</span></div>
    `;
    document.getElementById('laporan').appendChild(laporanExtra);
  }

  document.getElementById("harianHargaJual").textContent = formatRupiah(harian.hargaJual);
  document.getElementById("harianFee").textContent = formatRupiah(harian.fee);
  document.getElementById("harianTarikTunai").textContent = formatRupiah(harian.tarikTunai);
  document.getElementById("harianPengeluaran").textContent = formatRupiah(harian.pengeluaran);
  document.getElementById("harianKeuntunganKotor").textContent = formatRupiah(keuntunganKotorHarian);
  document.getElementById("harianKeuntunganBersih").textContent = formatRupiah(keuntunganBersihHarian);

  document.getElementById("bulananHargaJual").textContent = formatRupiah(bulanan.hargaJual);
  document.getElementById("bulananFee").textContent = formatRupiah(bulanan.fee);
  document.getElementById("bulananTarikTunai").textContent = formatRupiah(bulanan.tarikTunai);
  document.getElementById("bulananPengeluaran").textContent = formatRupiah(bulanan.pengeluaran);
  document.getElementById("bulananKeuntunganKotor").textContent = formatRupiah(keuntunganKotorBulanan);
  document.getElementById("bulananKeuntunganBersih").textContent = formatRupiah(keuntunganBersihBulanan);
}

// Fungsi tambah data ke Firebase dengan tanggal otomatis
function tambahData(refPath, data) {
  const dbRef = ref(db, refPath);
  data.tanggal = new Date().toISOString().slice(0,10);
  return push(dbRef, data);
}

// Form submit handlers

document.getElementById("formKonter").addEventListener("submit", e => {
  e.preventDefault();
  const nama = e.target.nama.value.trim();
  const hargaJual = Number(e.target.hargaJual.value);
  const fee = Number(e.target.fee.value);
  if(nama && hargaJual >= 0 && fee >= 0){
    tambahData('transaksi/konter', {nama, hargaJual, fee}).then(() => {
      e.target.reset();
      updateLaporan();
    });
  }
});

document.getElementById("formWarung").addEventListener("submit", e => {
  e.preventDefault();
  const nama = e.target.nama.value.trim();
  const hargaJual = Number(e.target.hargaJual.value);
  const fee = Number(e.target.fee.value);
  if(nama && hargaJual >= 0 && fee >= 0){
    tambahData('transaksi/warung', {nama, hargaJual, fee}).then(() => {
      e.target.reset();
      updateLaporan();
    });
  }
});

document.getElementById("formTarikTunai").addEventListener("submit", e => {
  e.preventDefault();
  const jumlah = Number(e.target.jumlah.value);
  const fee = Number(e.target.fee.value);
  if(jumlah >= 0 && fee >= 0){
    tambahData('transaksi/tarikTunai', {jumlah, fee}).then(() => {
      e.target.reset();
      updateLaporan();
    });
  }
});

document.getElementById("formPengeluaran").addEventListener("submit", e => {
  e.preventDefault();
  const nama = e.target.nama.value.trim();
  const jumlah = Number(e.target.jumlah.value);
  if(nama && jumlah >= 0){
    tambahData('transaksi/pengeluaran', {nama, jumlah}).then(() => {
      e.target.reset();
      updateLaporan();
    });
  }
});

// Auto update laporan saat load dan interval 10 detik untuk realtime feel
updateLaporan();
setInterval(updateLaporan, 10000);

</script>
</body>
</html>
