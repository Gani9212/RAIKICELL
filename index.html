<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>App Pembukuan</title>
<style>
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    height: 100vh;
    display: flex;
    background: #f0f4f8;
    color: #334155;
  }
  #sidebar {
    width: 240px;
    background: #1e293b;
    color: #cbd5e1;
    display: flex;
    flex-direction: column;
  }
  #sidebar h2 {
    margin: 1rem;
    font-weight: 700;
    font-size: 1.6rem;
    color: #f8fafc;
    user-select: none;
  }
  #sidebar nav a {
    padding: 1rem 1.5rem;
    display: block;
    text-decoration: none;
    color: #cbd5e1;
    border-left: 4px solid transparent;
    font-weight: 600;
    transition: background 0.25s, border-color 0.25s, color 0.25s;
  }
  #sidebar nav a.active,
  #sidebar nav a:hover {
    background: #334155;
    border-left-color: #3b82f6;
    color: #f8fafc;
  }

  #main-content {
    flex-grow: 1;
    padding: 2rem;
    overflow-y: auto;
  }
  h1 {
    margin-bottom: 1.5rem;
    font-weight: 700;
    color: #0f172a;
  }

  /* Tab content sections */
  .tab-content {
    display: none;
    background: white;
    border-radius: 8px;
    padding: 1.5rem 2rem;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.08);
    max-width: 720px;
  }
  .tab-content.active {
    display: block;
  }

  /* Laporan styling */
  #laporan .laporan-item {
    display: flex;
    justify-content: space-between;
    margin: 0.8rem 0;
    font-size: 1.1rem;
    color: #475569;
  }
  #laporan .laporan-item span.label {
    font-weight: 600;
  }
  #laporan .laporan-item span.value {
    font-family: 'Courier New', Courier, monospace;
    color: #0f172a;
  }
  #laporan hr {
    margin: 1.2rem 0;
    border: none;
    border-top: 1px solid #e2e8f0;
  }
  #laporan .keuntungan-kotor {
    font-weight: 700;
    font-size: 1.25rem;
    color: #1e40af;
  }
  #laporan .keuntungan-bersih {
    font-weight: 700;
    font-size: 1.25rem;
    color: #047857;
  }

  /* Forms */
  form {
    max-width: 600px;
  }
  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 600;
    color: #334155;
  }
  input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 0.4rem 0.6rem;
    margin-bottom: 1rem;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    font-size: 1rem;
    color: #334155;
  }
  button {
    background-color: #3b82f6;
    color: white;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s;
  }
  button:hover {
    background-color: #2563eb;
  }

  /* Table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
    font-size: 0.95rem;
  }
  th {
    background: #f1f5f9;
  }
  td.number {
    text-align: right;
    font-family: monospace;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Pembukuan</h2>
  <nav>
    <a href="#" class="active" data-tab="laporan">Laporan</a>
    <a href="#" data-tab="transaksi-konter">Transaksi Konter</a>
    <a href="#" data-tab="transaksi-warung">Transaksi Warung</a>
    <a href="#" data-tab="tarik-tunai">Tarik Tunai</a>
    <a href="#" data-tab="pengeluaran">Pengeluaran</a>
  </nav>
</div>

<div id="main-content">
  <h1>Dashboard Pembukuan</h1>

  <section id="laporan" class="tab-content active">
    <h3>Laporan Keuangan</h3>
    <div class="laporan-item"><span class="label">Total Harga Jual:</span> <span id="totalHargaJual" class="value">0</span></div>
    <div class="laporan-item"><span class="label">Total Fee:</span> <span id="totalFee" class="value">0</span></div>
    <div class="laporan-item"><span class="label">Total Tarik Tunai:</span> <span id="totalTarikTunai" class="value">0</span></div>
    <div class="laporan-item"><span class="label">Total Pengeluaran:</span> <span id="totalPengeluaran" class="value">0</span></div>
    <hr />
    <div class="laporan-item keuntungan-kotor"><span>Keuntungan Kotor:</span> <span id="keuntunganKotor" class="value">0</span></div>
    <div class="laporan-item keuntungan-bersih"><span>Keuntungan Bersih:</span> <span id="keuntunganBersih" class="value">0</span></div>
  </section>

  <section id="transaksi-konter" class="tab-content">
    <h3>Transaksi Konter</h3>
    <form id="formKonter">
      <label for="konterNama">Nama Barang:</label>
      <input type="text" id="konterNama" name="nama" required placeholder="Contoh: Pulsa 10k" />
      
      <label for="konterHargaJual">Harga Jual (Rp):</label>
      <input type="number" id="konterHargaJual" name="hargaJual" min="0" required />
      
      <label for="konterFee">Fee (Rp):</label>
      <input type="number" id="konterFee" name="fee" min="0" required />

      <button type="submit">Tambah Transaksi Konter</button>
    </form>

    <table id="tableKonter">
      <thead>
        <tr>
          <th>Nama Barang</th>
          <th>Harga Jual (Rp)</th>
          <th>Fee (Rp)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="transaksi-warung" class="tab-content">
    <h3>Transaksi Warung</h3>
    <form id="formWarung">
      <label for="warungNama">Nama Barang:</label>
      <input type="text" id="warungNama" name="nama" required placeholder="Contoh: Kopi Sachet" />
      
      <label for="warungHargaJual">Harga Jual (Rp):</label>
      <input type="number" id="warungHargaJual" name="hargaJual" min="0" required />
      
      <label for="warungFee">Fee (Rp):</label>
      <input type="number" id="warungFee" name="fee" min="0" required />

      <button type="submit">Tambah Transaksi Warung</button>
    </form>

    <table id="tableWarung">
      <thead>
        <tr>
          <th>Nama Barang</th>
          <th>Harga Jual (Rp)</th>
          <th>Fee (Rp)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="tarik-tunai" class="tab-content">
    <h3>Tarik Tunai</h3>
    <form id="formTarikTunai">
      <label for="tarikJumlah">Jumlah Tarik Tunai (Rp):</label>
      <input type="number" id="tarikJumlah" name="jumlah" min="0" required />
      <button type="submit">Tambah Tarik Tunai</button>
    </form>

    <table id="tableTarikTunai">
      <thead>
        <tr>
          <th>Jumlah Tarik Tunai (Rp)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="pengeluaran" class="tab-content">
    <h3>Pengeluaran</h3>
    <form id="formPengeluaran">
      <label for="pengeluaranNama">Keterangan:</label>
      <input type="text" id="pengeluaranNama" name="nama" required placeholder="Contoh: Beli Gas" />
      
      <label for="pengeluaranJumlah">Jumlah Pengeluaran (Rp):</label>
      <input type="number" id="pengeluaranJumlah" name="jumlah" min="0" required />
      
      <button type="submit">Tambah Pengeluaran</button>
    </form>

    <table id="tablePengeluaran">
      <thead>
        <tr>
          <th>Keterangan</th>
          <th>Jumlah Pengeluaran (Rp)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
  import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  // Firebase config dan init
  const firebaseConfig = {
    apiKey: "AIzaSyCoI53ZeXyaOBCOaczkPbHJpWzi0DX4b8g",
    authDomain: "raikicell.firebaseapp.com",
    databaseURL: "https://raikicell-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "raikicell",
    storageBucket: "raikicell.firebasestorage.app",
    messagingSenderId: "648628376778",
    appId: "1:648628376778:web:70098faf30f123ed6bd033",
    measurementId: "G-WWT1K74HHR"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  // Auto login dengan sessionStorage
  const userKey = 'userLoggedIn';
  let currentUser = sessionStorage.getItem(userKey);
  if (!currentUser) {
    currentUser = "admin"; // simple auto-login
    sessionStorage.setItem(userKey, currentUser);
  }

  // Format rupiah
  function formatRupiah(num) {
    return num.toLocaleString('id-ID');
  }

  // Tab handling
  const tabs = document.querySelectorAll('#sidebar nav a');
  const contents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.getAttribute('data-tab');
      contents.forEach(c => {
        c.classList.toggle('active', c.id === target);
        c.style.display = (c.id === target) ? 'block' : 'none';
      });
    });
  });

  // Update laporan
  async function updateLaporan() {
    const konterRef = ref(db, 'transaksi/konter');
    const warungRef = ref(db, 'transaksi/warung');
    const tarikTunaiRef = ref(db, 'transaksi/tarikTunai');
    const pengeluaranRef = ref(db, 'transaksi/pengeluaran');

    function fetchData(dbRef) {
      return new Promise(resolve => {
        onValue(dbRef, snapshot => resolve(snapshot), { onlyOnce: true });
      });
    }

    let totalHargaJual = 0;
    let totalFee = 0;
    let totalTarikTunai = 0;
    let totalPengeluaran = 0;

    // Data tabel konter
    const tableKonterBody = document.querySelector("#tableKonter tbody");
    tableKonterBody.innerHTML = "";

    // Data tabel warung
    const tableWarungBody = document.querySelector("#tableWarung tbody");
    tableWarungBody.innerHTML = "";

    // Data tabel tarik tunai
    const tableTarikTunaiBody = document.querySelector("#tableTarikTunai tbody");
    tableTarikTunaiBody.innerHTML = "";

    // Data tabel pengeluaran
    const tablePengeluaranBody = document.querySelector("#tablePengeluaran tbody");
    tablePengeluaranBody.innerHTML = "";

    // Load konter
    const konterSnap = await fetchData(konterRef);
    konterSnap.forEach(child => {
      const d = child.val();
      totalHargaJual += Number(d.hargaJual || 0);
      totalFee += Number(d.fee || 0);

      // Update tabel konter
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.nama}</td>
        <td class="number">${formatRupiah(Number(d.hargaJual))}</td>
        <td class="number">${formatRupiah(Number(d.fee))}</td>
      `;
      tableKonterBody.appendChild(tr);
    });

    // Load warung
    const warungSnap = await fetchData(warungRef);
    warungSnap.forEach(child => {
      const d = child.val();
      totalHargaJual += Number(d.hargaJual || 0);
      totalFee += Number(d.fee || 0);

      // Update tabel warung
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.nama}</td>
        <td class="number">${formatRupiah(Number(d.hargaJual))}</td>
        <td class="number">${formatRupiah(Number(d.fee))}</td>
      `;
      tableWarungBody.appendChild(tr);
    });

    // Load tarik tunai
    const tarikSnap = await fetchData(tarikTunaiRef);
    tarikSnap.forEach(child => {
      const d = child.val();
      totalTarikTunai += Number(d.jumlah || 0);
      // NOTE: fee tarik tunai tidak dihitung di fee, sesuai request fee hanya dari transaksi, 
      // tapi kalau mau fee tarik tunai juga dijumlah bisa ditambahkan di sini

      // Update tabel tarik tunai
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="number">${formatRupiah(Number(d.jumlah))}</td>`;
      tableTarikTunaiBody.appendChild(tr);
    });

    // Load pengeluaran
    const pengeluaranSnap = await fetchData(pengeluaranRef);
    pengeluaranSnap.forEach(child => {
      const d = child.val();
      totalPengeluaran += Number(d.jumlah || 0);

      // Update tabel pengeluaran
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.nama}</td>
        <td class="number">${formatRupiah(Number(d.jumlah))}</td>
      `;
      tablePengeluaranBody.appendChild(tr);
    });

    // Hitung keuntungan
    const keuntunganKotor = totalHargaJual - totalFee;
    const keuntunganBersih = keuntunganKotor - totalTarikTunai - totalPengeluaran;

    // Update UI laporan
    document.getElementById("totalHargaJual").textContent = formatRupiah(totalHargaJual);
    document.getElementById("totalFee").textContent = formatRupiah(totalFee);
    document.getElementById("totalTarikTunai").textContent = formatRupiah(totalTarikTunai);
    document.getElementById("totalPengeluaran").textContent = formatRupiah(totalPengeluaran);
    document.getElementById("keuntunganKotor").textContent = formatRupiah(keuntunganKotor);
    document.getElementById("keuntunganBersih").textContent = formatRupiah(keuntunganBersih);
  }

  // Submit handler untuk tambah transaksi konter
  document.getElementById('formKonter').addEventListener('submit', async e => {
    e.preventDefault();
    const nama = e.target.nama.value.trim();
    const hargaJual = Number(e.target.hargaJual.value);
    const fee = Number(e.target.fee.value);

    if (nama && hargaJual >= 0 && fee >= 0) {
      await push(ref(db, 'transaksi/konter'), { nama, hargaJual, fee });
      e.target.reset();
      updateLaporan();
    }
  });

  // Submit handler untuk tambah transaksi warung
  document.getElementById('formWarung').addEventListener('submit', async e => {
    e.preventDefault();
    const nama = e.target.nama.value.trim();
    const hargaJual = Number(e.target.hargaJual.value);
    const fee = Number(e.target.fee.value);

    if (nama && hargaJual >= 0 && fee >= 0) {
      await push(ref(db, 'transaksi/warung'), { nama, hargaJual, fee });
      e.target.reset();
      updateLaporan();
    }
  });

  // Submit handler untuk tarik tunai
  document.getElementById('formTarikTunai').addEventListener('submit', async e => {
    e.preventDefault();
    const jumlah = Number(e.target.jumlah.value);
    if (jumlah > 0) {
      await push(ref(db, 'transaksi/tarikTunai'), { jumlah });
      e.target.reset();
      updateLaporan();
    }
  });

  // Submit handler untuk pengeluaran
  document.getElementById('formPengeluaran').addEventListener('submit', async e => {
    e.preventDefault();
    const nama = e.target.nama.value.trim();
    const jumlah = Number(e.target.jumlah.value);

    if (nama && jumlah > 0) {
      await push(ref(db, 'transaksi/pengeluaran'), { nama, jumlah });
      e.target.reset();
      updateLaporan();
    }
  });

  // Initial laporan update
  updateLaporan();
</script>

</body>
</html>
