<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Pembukuan Raikicell</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex;
      background: #f4f7fa;
    }
    #sidebar {
      width: 220px; background: #2c3e50; color: white;
      display: flex; flex-direction: column; padding: 20px;
      box-sizing: border-box;
    }
    #sidebar button {
      background: none; border: none; color: white;
      padding: 15px 10px; text-align: left; cursor: pointer;
      font-size: 16px; border-radius: 5px; margin-bottom: 10px;
      transition: background 0.3s;
    }
    #sidebar button.active, #sidebar button:hover {
      background: #34495e;
    }
    #mainContent {
      flex: 1; padding: 20px; overflow-y: auto;
      box-sizing: border-box;
    }
    form > * {
      display: block; margin-bottom: 10px; width: 100%;
      padding: 8px; font-size: 14px; box-sizing: border-box;
    }
    form button {
      width: auto; padding: 10px 20px;
      background: #27ae60; border: none; color: white;
      cursor: pointer; border-radius: 4px;
    }
    form button:hover {
      background: #219150;
    }
    ul {
      list-style: none; padding-left: 0; max-height: 300px; overflow-y: auto;
      border: 1px solid #ccc; border-radius: 5px;
    }
    li {
      padding: 10px; background: white; margin-bottom: 5px;
      display: flex; justify-content: space-between; align-items: center;
      border-radius: 3px;
    }
    .delete-button {
      background: #e74c3c; border: none; color: white;
      cursor: pointer; border-radius: 3px; padding: 5px 10px;
    }
    .delete-button:hover {
      background: #c0392b;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    h2 {
      margin-top: 0;
    }
    .report-result {
      margin-top: 10px; font-weight: bold;
      background: white; padding: 10px; border-radius: 5px;
      border: 1px solid #ccc;
      max-width: 400px;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <button data-tab="konter" class="active">Transaksi Konter</button>
    <button data-tab="warung">Transaksi Warung</button>
    <button data-tab="tariktunai">Tarik Tunai</button>
    <button data-tab="pengeluaran">Pengeluaran</button>
    <button data-tab="barang">Admin Barang</button>
    <button data-tab="laporan">Laporan</button>
  </div>

  <div id="mainContent">
    <!-- TRANSAKSI KONTER -->
    <div id="tab-konter" class="tab-content active">
      <h2>Transaksi Konter</h2>
      <form id="formTransaksiKonter">
        <input type="date" id="tglKonter" required />
        <input type="text" id="namaBarangKonter" placeholder="Nama Barang" required />
        <input type="number" id="hargaKonter" placeholder="Harga" required min="0" />
        <input type="number" id="feeKonter" placeholder="Fee" required min="0" />
        <button type="submit">Simpan</button>
      </form>
      <ul id="listTransaksiKonter"></ul>
    </div>

    <!-- TRANSAKSI WARUNG -->
    <div id="tab-warung" class="tab-content">
      <h2>Transaksi Warung</h2>
      <form id="formTransaksiWarung">
        <input type="date" id="tglWarung" required />
        <input type="text" id="namaBarangWarung" placeholder="Nama Barang" required />
        <input type="number" id="hargaWarung" placeholder="Harga" required min="0" />
        <input type="number" id="feeWarung" placeholder="Fee" required min="0" />
        <button type="submit">Simpan</button>
      </form>
      <ul id="listTransaksiWarung"></ul>
    </div>

    <!-- TARIK TUNAI -->
    <div id="tab-tariktunai" class="tab-content">
      <h2>Tarik Tunai</h2>
      <form id="formTarikTunai">
        <input type="date" id="tglTarikTunai" required />
        <input type="number" id="jumlahTarikTunai" placeholder="Jumlah" required min="0" />
        <input type="number" id="feeTarikTunai" placeholder="Fee" required min="0" />
        <button type="submit">Simpan</button>
      </form>
      <ul id="listTarikTunai"></ul>
    </div>

    <!-- PENGELUARAN -->
    <div id="tab-pengeluaran" class="tab-content">
      <h2>Pengeluaran</h2>
      <form id="formPengeluaran">
        <input type="date" id="tglPengeluaran" required />
        <input type="text" id="namaPengeluaran" placeholder="Nama Pengeluaran" required />
        <input type="number" id="jumlahPengeluaran" placeholder="Jumlah" required min="0" />
        <button type="submit">Simpan</button>
      </form>
      <ul id="listPengeluaran"></ul>
    </div>

    <!-- ADMIN BARANG -->
    <div id="tab-barang" class="tab-content">
      <h2>Admin Barang</h2>
      <form id="formAdmin">
        <input type="text" id="namaBarangAdmin" placeholder="Nama Barang" required />
        <input type="number" id="hargaAdmin" placeholder="Harga" required min="0" />
        <input type="number" id="feeAdmin" placeholder="Fee" required min="0" />
        <button type="submit">Tambah Barang</button>
      </form>
      <input type="text" id="searchBarang" placeholder="Cari Barang..." style="margin-top:10px; padding:8px; width: 100%; box-sizing: border-box;" />
      <ul id="listBarangAdmin"></ul>
    </div>

    <!-- LAPORAN -->
    <div id="tab-laporan" class="tab-content">
      <h2>Laporan</h2>

      <div>
        <h3>Laporan Harian</h3>
        <input type="date" id="tanggalLaporanHarian" />
        <button id="btnGenerateLaporanHarian">Generate Laporan Harian</button>
        <div id="laporanHarianResult" class="report-result"></div>
      </div>

      <div style="margin-top:20px;">
        <h3>Laporan Bulanan</h3>
        <input type="month" id="bulanLaporanBulanan" />
        <button id="btnGenerateLaporanBulanan">Generate Laporan Bulanan</button>
        <div id="laporanBulananResult" class="report-result"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    // Konfigurasi Firebase (ganti sesuai proyek lo)
    const firebaseConfig = {
      apiKey: "AIzaSyCoI53ZeXyaOBCOaczkPbHJpWzi0DX4b8g",
      authDomain: "raikicell.firebaseapp.com",
      databaseURL: "https://raikicell-default-rtdb.firebaseio.com",
      projectId: "raikicell",
      storageBucket: "raikicell.appspot.com",
      messagingSenderId: "648628376778",
      appId: "1:648628376778:web:961ca9084abeeb206bd033"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // GLOBALS
    let userId = null;

    // Format rupiah helper
    function formatRupiah(angka) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka);
    }

    // ---------------------------------------
    // Login Anonymous & mulai load data
    auth.signInAnonymously()
      .then(() => {
        userId = auth.currentUser.uid;
        console.log('Login anon sukses, uid:', userId);
        setupListeners();
        loadAllData();
      })
      .catch(err => {
        alert('Login error: ' + err.message);
      });

    // ---------------------------------------
    // UI Tab switch
    const sidebarButtons = document.querySelectorAll('#sidebar button');
    const tabContents = document.querySelectorAll('.tab-content');
    sidebarButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        sidebarButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        tabContents.forEach(tc => {
          tc.classList.toggle('active', tc.id === 'tab-' + tab);
        });
      });
    });

    // ---------------------------------------
    // SIMPAN DATA KE FIREBASE

    function simpanData(path, data) {
      const ref = db.ref(`users/${userId}/${path}`);
      return ref.push(data);
    }

    // Hapus item berdasarkan key di firebase
    function hapusData(path, key) {
      const ref = db.ref(`users/${userId}/${path}/${key}`);
      return ref.remove();
    }

    // ---------------------------------------
    // RENDER DATA LIST & BINDING FORM SUBMIT

    // Transaksi Konter
    const listTransaksiKonter = document.getElementById('listTransaksiKonter');
    const formTransaksiKonter = document.getElementById('formTransaksiKonter');
    formTransaksiKonter.addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        tanggal: document.getElementById('tglKonter').value,
        namaBarang: document.getElementById('namaBarangKonter').value.trim(),
        harga: Number(document.getElementById('hargaKonter').value),
        fee: Number(document.getElementById('feeKonter').value)
      };
      if (!data.tanggal || !data.namaBarang || isNaN(data.harga) || isNaN(data.fee)) {
        return alert('Input tidak valid!');
      }
      simpanData('transaksiKonter', data)
        .then(() => formTransaksiKonter.reset())
        .catch(e => alert('Gagal simpan: ' + e.message));
    });

    function renderTransaksiKonter(data) {
      listTransaksiKonter.innerHTML = '';
      Object.entries(data).forEach(([key, val]) => {
        const li = document.createElement('li');
        li.textContent = `${val.tanggal} | ${val.namaBarang} | ${formatRupiah(val.harga)} | Fee: ${formatRupiah(val.fee)}`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Hapus';
        delBtn.classList.add('delete-button');
        delBtn.onclick = () => {
          if (confirm('Yakin hapus transaksi ini?')) {
            hapusData('transaksiKonter', key);
          }
        };
        li.appendChild(delBtn);
        listTransaksiKonter.appendChild(li);
      });
    }

    // Transaksi Warung
    const listTransaksiWarung = document.getElementById('listTransaksiWarung');
    const formTransaksiWarung = document.getElementById('formTransaksiWarung');
    formTransaksiWarung.addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        tanggal: document.getElementById('tglWarung').value,
        namaBarang: document.getElementById('namaBarangWarung').value.trim(),
        harga: Number(document.getElementById('hargaWarung').value),
        fee: Number(document.getElementById('feeWarung').value)
      };
      if (!data.tanggal || !data.namaBarang || isNaN(data.harga) || isNaN(data.fee)) {
        return alert('Input tidak valid!');
      }
      simpanData('transaksiWarung', data)
        .then(() => formTransaksiWarung.reset())
        .catch(e => alert('Gagal simpan: ' + e.message));
    });

    function renderTransaksiWarung(data) {
      listTransaksiWarung.innerHTML = '';
      Object.entries(data).forEach(([key, val]) => {
        const li = document.createElement('li');
        li.textContent = `${val.tanggal} | ${val.namaBarang} | ${formatRupiah(val.harga)} | Fee: ${formatRupiah(val.fee)}`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Hapus';
        delBtn.classList.add('delete-button');
        delBtn.onclick = () => {
          if (confirm('Yakin hapus transaksi ini?')) {
            hapusData('transaksiWarung', key);
          }
        };
        li.appendChild(delBtn);
        listTransaksiWarung.appendChild(li);
      });
    }

    // Tarik Tunai
    const listTarikTunai = document.getElementById('listTarikTunai');
    const formTarikTunai = document.getElementById('formTarikTunai');
    formTarikTunai.addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        tanggal: document.getElementById('tglTarikTunai').value,
        jumlah: Number(document.getElementById('jumlahTarikTunai').value),
        fee: Number(document.getElementById('feeTarikTunai').value)
      };
      if (!data.tanggal || isNaN(data.jumlah) || isNaN(data.fee)) {
        return alert('Input tidak valid!');
      }
      simpanData('tarikTunai', data)
        .then(() => formTarikTunai.reset())
        .catch(e => alert('Gagal simpan: ' + e.message));
    });

    function renderTarikTunai(data) {
      listTarikTunai.innerHTML = '';
      Object.entries(data).forEach(([key, val]) => {
        const li = document.createElement('li');
        li.textContent = `${val.tanggal} | Jumlah: ${formatRupiah(val.jumlah)} | Fee: ${formatRupiah(val.fee)}`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Hapus';
        delBtn.classList.add('delete-button');
        delBtn.onclick = () => {
          if (confirm('Yakin hapus transaksi ini?')) {
            hapusData('tarikTunai', key);
          }
        };
        li.appendChild(delBtn);
        listTarikTunai.appendChild(li);
      });
    }

    // Pengeluaran
    const listPengeluaran = document.getElementById('listPengeluaran');
    const formPengeluaran = document.getElementById('formPengeluaran');
    formPengeluaran.addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        tanggal: document.getElementById('tglPengeluaran').value,
        namaPengeluaran: document.getElementById('namaPengeluaran').value.trim(),
        jumlah: Number(document.getElementById('jumlahPengeluaran').value)
      };
      if (!data.tanggal || !data.namaPengeluaran || isNaN(data.jumlah)) {
        return alert('Input tidak valid!');
      }
      simpanData('pengeluaran', data)
        .then(() => formPengeluaran.reset())
        .catch(e => alert('Gagal simpan: ' + e.message));
    });

    function renderPengeluaran(data) {
      listPengeluaran.innerHTML = '';
      Object.entries(data).forEach(([key, val]) => {
        const li = document.createElement('li');
        li.textContent = `${val.tanggal} | ${val.namaPengeluaran} | ${formatRupiah(val.jumlah)}`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Hapus';
        delBtn.classList.add('delete-button');
        delBtn.onclick = () => {
          if (confirm('Yakin hapus pengeluaran ini?')) {
            hapusData('pengeluaran', key);
          }
        };
        li.appendChild(delBtn);
        listPengeluaran.appendChild(li);
      });
    }

    // Admin Barang
    const listBarangAdmin = document.getElementById('listBarangAdmin');
    const formAdmin = document.getElementById('formAdmin');
    const searchBarangInput = document.getElementById('searchBarang');

    formAdmin.addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        namaBarang: document.getElementById('namaBarangAdmin').value.trim(),
        harga: Number(document.getElementById('hargaAdmin').value),
        fee: Number(document.getElementById('feeAdmin').value)
      };
      if (!data.namaBarang || isNaN(data.harga) || isNaN(data.fee)) {
        return alert('Input tidak valid!');
      }
      simpanData('adminBarang', data)
        .then(() => {
          formAdmin.reset();
          loadAdminBarang();
        })
        .catch(e => alert('Gagal simpan: ' + e.message));
    });

    let allBarang = {};

    function renderAdminBarang(data, filter = '') {
      allBarang = data || {};
      listBarangAdmin.innerHTML = '';
      Object.entries(allBarang).forEach(([key, val]) => {
        if (!val.namaBarang.toLowerCase().includes(filter.toLowerCase())) return;
        const li = document.createElement('li');
        li.textContent = `${val.namaBarang} | Harga: ${formatRupiah(val.harga)} | Fee: ${formatRupiah(val.fee)}`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Hapus';
        delBtn.classList.add('delete-button');
        delBtn.onclick = () => {
          if (confirm('Yakin hapus barang ini?')) {
            hapusData('adminBarang', key).then(() => loadAdminBarang());
          }
        };
        li.appendChild(delBtn);
        listBarangAdmin.appendChild(li);
      });
    }

    searchBarangInput.addEventListener('input', e => {
      renderAdminBarang(allBarang, e.target.value);
    });

    function loadAdminBarang() {
      db.ref(`users/${userId}/adminBarang`).once('value')
        .then(snapshot => {
          const val = snapshot.val() || {};
          renderAdminBarang(val, searchBarangInput.value);
        });
    }

    // ---------------------------------------
    // LOAD ALL DATA (and realtime listeners)

    function loadAllData() {
      // Transaksi Konter realtime listener
      db.ref(`users/${userId}/transaksiKonter`).on('value', snapshot => {
        renderTransaksiKonter(snapshot.val() || {});
      });
      // Transaksi Warung realtime listener
      db.ref(`users/${userId}/transaksiWarung`).on('value', snapshot => {
        renderTransaksiWarung(snapshot.val() || {});
      });
      // Tarik Tunai realtime listener
      db.ref(`users/${userId}/tarikTunai`).on('value', snapshot => {
        renderTarikTunai(snapshot.val() || {});
      });
      // Pengeluaran realtime listener
      db.ref(`users/${userId}/pengeluaran`).on('value', snapshot => {
        renderPengeluaran(snapshot.val() || {});
      });
      // Admin Barang realtime listener
      db.ref(`users/${userId}/adminBarang`).on('value', snapshot => {
        renderAdminBarang(snapshot.val() || {}, searchBarangInput.value);
      });
    }

    // ---------------------------------------
    // LAPORAN
    const btnGenerateLaporanHarian = document.getElementById('btnGenerateLaporanHarian');
    const laporanHarianResult = document.getElementById('laporanHarianResult');

    btnGenerateLaporanHarian.addEventListener('click', () => {
      const tgl = document.getElementById('tanggalLaporanHarian').value;
      if (!tgl) {
        alert('Pilih tanggal dulu!');
        return;
      }
      generateLaporan('harian', tgl);
    });

    const btnGenerateLaporanBulanan = document.getElementById('btnGenerateLaporanBulanan');
    const laporanBulananResult = document.getElementById('laporanBulananResult');

    btnGenerateLaporanBulanan.addEventListener('click', () => {
      const bulan = document.getElementById('bulanLaporanBulanan').value;
      if (!bulan) {
        alert('Pilih bulan dulu!');
        return;
      }
      generateLaporan('bulanan', bulan);
    });

    // Ambil semua data dari semua jenis transaksi sekaligus
    async function fetchAllData() {
      const paths = ['transaksiKonter', 'transaksiWarung', 'tarikTunai', 'pengeluaran'];
      let results = {};
      for (const p of paths) {
        const snap = await db.ref(`users/${userId}/${p}`).once('value');
        results[p] = snap.val() || {};
      }
      return results;
    }

    // Generate laporan harian atau bulanan
    async function generateLaporan(type, value) {
      laporanHarianResult.textContent = '';
      laporanBulananResult.textContent = '';
      const data = await fetchAllData();

      let filtered = {
        transaksiKonter: {},
        transaksiWarung: {},
        tarikTunai: {},
        pengeluaran: {}
      };

      if (type === 'harian') {
        // filter by exact date yyyy-mm-dd
        Object.entries(data.transaksiKonter).forEach(([k,v]) => { if(v.tanggal === value) filtered.transaksiKonter[k]=v; });
        Object.entries(data.transaksiWarung).forEach(([k,v]) => { if(v.tanggal === value) filtered.transaksiWarung[k]=v; });
        Object.entries(data.tarikTunai).forEach(([k,v]) => { if(v.tanggal === value) filtered.tarikTunai[k]=v; });
        Object.entries(data.pengeluaran).forEach(([k,v]) => { if(v.tanggal === value) filtered.pengeluaran[k]=v; });
      } else if (type === 'bulanan') {
        // filter by yyyy-mm (prefix of tanggal)
        Object.entries(data.transaksiKonter).forEach(([k,v]) => { if(v.tanggal.startsWith(value)) filtered.transaksiKonter[k]=v; });
        Object.entries(data.transaksiWarung).forEach(([k,v]) => { if(v.tanggal.startsWith(value)) filtered.transaksiWarung[k]=v; });
        Object.entries(data.tarikTunai).forEach(([k,v]) => { if(v.tanggal.startsWith(value)) filtered.tarikTunai[k]=v; });
        Object.entries(data.pengeluaran).forEach(([k,v]) => { if(v.tanggal.startsWith(value)) filtered.pengeluaran[k]=v; });
      }

      // Kalkulasi total
      let totalPendapatanKonter = 0;
      let totalPendapatanWarung = 0;
      let totalTarikTunai = 0;
      let totalPengeluaran = 0;
      let totalFee = 0;

      Object.values(filtered.transaksiKonter).forEach(v => {
        totalPendapatanKonter += v.harga;
        totalFee += v.fee;
      });
      Object.values(filtered.transaksiWarung).forEach(v => {
        totalPendapatanWarung += v.harga;
        totalFee += v.fee;
      });
      Object.values(filtered.tarikTunai).forEach(v => {
        totalTarikTunai += v.jumlah;
        totalFee += v.fee;
      });
      Object.values(filtered.pengeluaran).forEach(v => {
        totalPengeluaran += v.jumlah;
      });

      // Hitung keuntungan: (pendapatan konter + warung + tarik tunai) - pengeluaran - fee
      const keuntungan = (totalPendapatanKonter + totalPendapatanWarung + totalTarikTunai) - totalPengeluaran - totalFee;

      const hasil =
        `Pendapatan Konter: ${formatRupiah(totalPendapatanKonter)}\n` +
        `Pendapatan Warung: ${formatRupiah(totalPendapatanWarung)}\n` +
        `Tarik Tunai: ${formatRupiah(totalTarikTunai)}\n` +
        `Total Fee: ${formatRupiah(totalFee)}\n` +
        `Pengeluaran: ${formatRupiah(totalPengeluaran)}\n` +
        `\nKeuntungan Bersih: ${formatRupiah(keuntungan)}`;

      if (type === 'harian') {
        laporanHarianResult.textContent = hasil;
      } else {
        laporanBulananResult.textContent = hasil;
      }
    }

  </script>
</body>
</html>
